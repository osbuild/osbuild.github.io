<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developer-guide/projects/images/test/README" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">osbuild/images testing information | Image Builder</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://osbuild.org/docs/developer-guide/projects/images/test/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="osbuild/images testing information | Image Builder"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://osbuild.org/docs/developer-guide/projects/images/test/"><link data-rh="true" rel="alternate" href="https://osbuild.org/docs/developer-guide/projects/images/test/" hreflang="en"><link data-rh="true" rel="alternate" href="https://osbuild.org/docs/developer-guide/projects/images/test/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2d858f81.css">
<script src="/assets/js/runtime~main.923593ad.js" defer="defer"></script>
<script src="/assets/js/main.345a08f0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="osbuild logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.svg" alt="osbuild logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Image Builder</b></a><a class="navbar__item navbar__link" href="/docs/hosted/architecture/">Hosted</a><a class="navbar__item navbar__link" href="/docs/on-premises/overview/">On Premises</a><a class="navbar__item navbar__link" href="/docs/bootc/">Bootc</a><a class="navbar__item navbar__link" href="/docs/user-guide/introduction/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/developer-guide/index/">Developer Guide</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/osbuild/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/developer-guide/index/">Developer Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/developer-guide/general/">General Topics</a><button aria-label="Expand sidebar category &#x27;General Topics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/developer-guide/projects/">Project Overview</a><button aria-label="Collapse sidebar category &#x27;Project Overview&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/composer-cli/">composer-cli</a><button aria-label="Expand sidebar category &#x27;composer-cli&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/image-builder/">image-builder</a><button aria-label="Expand sidebar category &#x27;image-builder&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/image-builder-crc/">Image Builder console.redhat.com Middleware</a><button aria-label="Expand sidebar category &#x27;Image Builder console.redhat.com Middleware&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer-guide/projects/image-builder-frontend/">Image Builder Frontend</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/developer-guide/projects/images/">Images</a><button aria-label="Collapse sidebar category &#x27;Images&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/developer-guide/projects/images/docs/developer/">docs</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer-guide/projects/images/test/">osbuild/images testing information</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/koji-image-builder/">koji-image-builder</a><button aria-label="Expand sidebar category &#x27;koji-image-builder&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/osbuild/">OSBuild</a><button aria-label="Expand sidebar category &#x27;OSBuild&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/osbuild-composer/">OSBuild Composer</a><button aria-label="Expand sidebar category &#x27;OSBuild Composer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer-guide/projects/rpmrepo/">RPMrepo Snapshots</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer-guide/projects/"><span itemprop="name">Project Overview</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer-guide/projects/images/"><span itemprop="name">Images</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">osbuild/images testing information</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>osbuild/images testing information</h1></header>
<p>The &quot;images&quot; project contains many integration tests that are defined in this directory
and are run via the gitlab CI.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-filesdirectories">Core files/directories<a href="#core-filesdirectories" class="hash-link" aria-label="Direct link to Core files/directories" title="Direct link to Core files/directories">​</a></h2>
<p><a href="https://github.com/osbuild/images/tree/main/test/configs/" target="_blank" rel="noopener noreferrer">./test/configs/</a> contains configuration files for building images for testing. The files are used by the following tools:</p>
<ul>
<li><a href="https://github.com/osbuild/images/tree/main/cmd/build" target="_blank" rel="noopener noreferrer">./cmd/build</a> takes a config file as argument to build an image.  For example:</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go build -o bin/build ./cmd/build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ./bin/build --output ./buildtest --rpmmd /tmp/rpmmd --distro fedora-41 --type qcow2 --config test/configs/embed-containers.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>will build a Fedora 38 qcow2 image using the configuration specified in the file <code>embed-containers.json</code></p>
<ul>
<li><a href="https://github.com/osbuild/images/tree/main/cmd/gen-manifests" target="_blank" rel="noopener noreferrer">./cmd/gen-manifests</a> generates manifests based on the configs specified in <a href="https://github.com/osbuild/images/tree/main/test/config-list.json" target="_blank" rel="noopener noreferrer">./test/config-list.json</a>. The config list maps configuration files to image types, distributions, and architectures.  An empty list means it applies to all values.  Globs are supported.</li>
</ul>
<p>The config list is also used in CI to dynamically generate test builds using the <a href="https://github.com/osbuild/images/tree/main/test/scripts/generate-build-config" target="_blank" rel="noopener noreferrer">./test/scripts/generate-build-config</a> and <a href="https://github.com/osbuild/images/tree/main/test/scripts/generate-ostree-build-config" target="_blank" rel="noopener noreferrer">./test/scripts/generate-ostree-build-config</a> scripts.</p>
<ul>
<li>
<p><a href="https://github.com/osbuild/images/tree/main/test/data/repositories/" target="_blank" rel="noopener noreferrer">./test/data/repositories/</a> contains repository configurations for manifest generation (<a href="https://github.com/osbuild/images/tree/main/cmd/gen-manifests" target="_blank" rel="noopener noreferrer">./cmd/gen-manifests</a>) and image building (<a href="https://github.com/osbuild/images/tree/main/cmd/build" target="_blank" rel="noopener noreferrer">./cmd/build</a>).</p>
</li>
<li>
<p><code>Schutzfile</code> defines content sources and test variables:</p>
<ul>
<li><code>common.rngseed</code> is the random number generator seed that is used by all the test scripts and commands. It ensures manifests are always generated with the same random values (e.g. for partition UUIDs) so tests can be skipped when an image hasn&#x27;t changed (see <a href="#workflow-details">Workflow details</a>) below. This value can be changed (incremented) when a rebuild of all test images is required. For example, if a test script changes in a way that will not affect the manifests, this value can be used to make sure all test images are built.</li>
<li>The following are defined in an object keyed by a distro name (e.g. <code>fedora-41</code>). The distribution name and version must match the version of the CI runners.</li>
<li><code>dependencies.osbuild.commit</code>: the version of osbuild to use, as a commit ID. This must be a commit that was successfully built in osbuild&#x27;s CI, so that RPMs will be available. It is used by <a href="https://github.com/osbuild/images/tree/main/test/scripts/setup-osbuild-repo" target="_blank" rel="noopener noreferrer">./test/scripts/setup-osbuild-repo</a>.</li>
<li><code>repos</code>: the repository configurations to use on the runners to install packages such as build dependencies and test tools.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manually-image-testing">Manually image testing<a href="#manually-image-testing" class="hash-link" aria-label="Direct link to Manually image testing" title="Direct link to Manually image testing">​</a></h2>
<p>While most of this document describes our automatic setup, here are some useful tips if manual
testing/inspection of images is required.</p>
<p>To build an image just run <code>build-image</code>, then it can be booted with <code>boot-image</code> and the
switch <code>--keep-booted</code> will keep it around for inspection via ssh (not all image types support
this yet). E.g.:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./test/scripts/build-image centos-10 qcow2 ./tests/configs/empty.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./test/scripts/bootc-image --keep-booted ./build/centos_10-x86_64-qcow2-empty/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">***********************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keeping the image build/centos_10-x86_64-qcow2-empty/qcow2/disk.qcow2 booted as requested, press enter or ctrl-c to stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">to connect run:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i /tmp/tmpg56bxqko/testkey -p 52387 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no osbuild@localhost</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The ssh command can just be copy/pasted and gives access to the vm running the image. The
<code>check-host-config</code> binary and configuration will be availabe inside /tmp to inspect/run.</p>
<p>If qemu-user-static/qemu-system-$arch is installed <code>build-image --arch &lt;arch&gt;</code> is also supported,
e.g. <code>build-image --arch ppc64le centos-10 qcow2 ./tests/configs/empty.json</code> will create a
ppc64le qcow2 image. The <code>boot-image</code> script will auto-detect the architecture and boot the
vm accordingly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-image-build-tests-locally">Running image build tests locally<a href="#running-image-build-tests-locally" class="hash-link" aria-label="Direct link to Running image build tests locally" title="Direct link to Running image build tests locally">​</a></h2>
<p>Some image build tests are available to run locally via qemu. The easiest way to discover them is to
run:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo pytest --collect-only ./test/test_build_integration.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This wil give a list of tests and their distro/arch/image-type permuations. Currently there are
two tests:</p>
<ol>
<li>Build the artifact (usually a disk image but can be a container)</li>
<li>Build the image and boot test it</li>
</ol>
<p>With:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo pytest --collect-only ./test/test_build_integration.py::test_build_only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo pytest --collect-only ./test/test_build_integration.py::test_build_and_boot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>it is easy to see which combinations are boot tested and which are build only.</p>
<p>The usual commands from pytest are available, so to e.g. filter for all centos-10 tests
the commandline is:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo pytest --collect-only ./test/test_build_integration.py -k centos-10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;Dir images&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;Dir test&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;Module test_build_integration.py&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;Function test_build_only[centos-10-x86_64-ova-jq-only]&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;Function test_build_and_boot[centos-10-x86_64-qcow2-jq-only]&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Running a specific test is also straightforward this way:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo pytest -s -v ./test/test_build_integration.py::test_build_and_boot[centos-10-x86_64-qcow2-jq-only]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that some tests require AWS or similar credentials/secrets but all qcow2 or installer
tests will run without extra configuration. Also note that the pytests are a thin wrapper
around the gen-manifests/build-image/boot-image commands that are explained in detail below.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="image-build-tests-in-gitlab-ci">Image build tests in GitLab CI<a href="#image-build-tests-in-gitlab-ci" class="hash-link" aria-label="Direct link to Image build tests in GitLab CI" title="Direct link to Image build tests in GitLab CI">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p>Images are built in GitLab CI when a change in an image definition is detected. The config generator scripts generate all the manifests and create a child pipeline with one job for each manifest and builds the image. On successful build, the result is stored in an s3 bucket by manifest ID. Subsequent runs of the generator script check the cache and only build manifests when their ID is not found in the cache.</p>
<p>Each generator script is run separately for every distribution and architecture combination that the project supports. These are also generated dynamically using <code>./cmd/list-images</code>. The dynamic test generation workflow looks like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gitlab-ci.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   For each distro/arch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- generate-build-configs-&lt;distro&gt;-&lt;arch&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|         | (Dynamic: For each modified image type and config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|         |-- Build &lt;distro&gt;-&lt;arch&gt;-&lt;image&gt;-&lt;config&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   For each distro/arch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- generate-ostree-build-configs-&lt;distro&gt;-&lt;arch&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          | (Dynamic: For each modified image type and config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |-- Build &lt;distro&gt;-&lt;arch&gt;-&lt;image&gt;-&lt;config&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The top-level <code>.gitlab-ci.yml</code> is generated using <code>./tools/prepare-source.sh</code> (which calls <code>./test/scripts/generate-gitlab-ci</code>) and must be updated when a change is made to the image configurations (distros, architectures, image types).  A PR will fail if the generated version does not match the one checked into the repository.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-pipelines">Dynamic pipelines<a href="#dynamic-pipelines" class="hash-link" aria-label="Direct link to Dynamic pipelines" title="Direct link to Dynamic pipelines">​</a></h3>
<p>Jobs are created dynamically using GitLab CI&#x27;s <a href="https://docs.gitlab.com/ee/ci/pipelines/downstream_pipelines.html#dynamic-child-pipelines" target="_blank" rel="noopener noreferrer">Dynamic child pipelines</a> feature. A simple example of how this works that mimics the setup of the pipeline generation in this project (but with very simple bash scripts) can be found in the <a href="https://gitlab.com/redhat/services/products/image-builder/ci/dynamic-pipeline-demo" target="_blank" rel="noopener noreferrer">image-builder/ci/dynamic-pipeline-demo</a> project on GitLab. The project contains an <a href="https://gitlab.com/redhat/services/products/image-builder/ci/dynamic-pipeline-demo/-/blob/5914c7432eaa810cfea7ca35ffb9f01700197b02/.gitlab-ci.yml" target="_blank" rel="noopener noreferrer">annotated <code>.gitlab-ci.yml</code> file</a> and <a href="https://gitlab.com/redhat/services/products/image-builder/ci/dynamic-pipeline-demo/-/tree/5914c7432eaa810cfea7ca35ffb9f01700197b02/scripts" target="_blank" rel="noopener noreferrer">a couple of bash scripts</a> that generate pipeline configurations dynamically.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-details">Workflow details<a href="#workflow-details" class="hash-link" aria-label="Direct link to Workflow details" title="Direct link to Workflow details">​</a></h3>
<p>The following describe the stages that are run for each distro-arch combination.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-generate-build-config">1. Generate build config<a href="#1-generate-build-config" class="hash-link" aria-label="Direct link to 1. Generate build config" title="Direct link to 1. Generate build config">​</a></h4>
<p>The first stage of the workflow runs the <code>./test/generate-build-config</code> script.</p>
<p>The config generator:</p>
<ul>
<li>Generates all the manifests for a given distribution and architecture using the <code>./cmd/gen-manifests</code> tool.</li>
<li>Downloads the test build cache.</li>
<li>Filters out any manifest with an ID that exists in the build cache.<!-- -->
<ul>
<li>It also filters out any manifest that depends on an ostree commit because these can&#x27;t be built without an ostree repository to pull from.</li>
</ul>
</li>
<li>For each remaining manifest, creates a job which builds, boots (if applicable), and uploads the results to the build cache for a given distro, image type, and config file.<!-- -->
<ul>
<li><code>./test/scripts/build-image</code> builds the image using osbuild.</li>
<li><code>./test/scripts/boot-image</code> boots the image in the appropriate cloud or virtual environment (if supported).</li>
<li><code>./test/scripts/upload-results</code> uploads the results (manifest, image file, and build info) to the CI S3 bucket, so that rebuilds of the same manifest ID can be skipped.</li>
<li>For ostree container image types (<code>iot-container</code> and <code>edge-container</code>), it also adds a call to the <code>./tools/ci/push-container.sh</code> script to push the container to the GitLab registry. The name and tag for each container is <code>&lt;build name&gt;:&lt;manifest ID&gt;</code> (see <a href="#definitions">Definitions</a> below).</li>
</ul>
</li>
<li>If no builds are needed, it generates a <code>NullConfig</code>, which is a simple shell runner that exits successfully. This is required because the child pipeline config cannot be empty.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-dynamic-build-job">2. Dynamic build job<a href="#2-dynamic-build-job" class="hash-link" aria-label="Direct link to 2. Dynamic build job" title="Direct link to 2. Dynamic build job">​</a></h4>
<p>Each build job runs in parallel. For each image that is successfully built, a file is added to the test build cache under the following path:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;distro&gt;/&lt;arch&gt;/&lt;osbuild NEVRA&gt;/&lt;manifest ID&gt;/info.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each file in the cache stores information relevant to the build,
in the form</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;distro&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;distro&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;arch&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;arch&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;image-type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;image type&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;config&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;config name&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;manifest-checksum&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;manifest ID&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;osbuild-version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;osbuild version&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;osbuild-commit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;osbuild commit ID&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;commit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;commit ID&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;boot-success&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;pr&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;PR number&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(see <a href="#definitions">Definitions</a> below)</p>
<p>for example:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;distro&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fedora-40&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;arch&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;x86_64&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;image-type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;qcow2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;config&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;all-customizations&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;manifest-checksum&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8c0ce3987d78fe6f3307494cd57ceed861de61c3b04786d6a7f570faacbdb5df&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;osbuild-version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;osbuild 89&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;osbuild-commit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;74392a0238dec6bfa3f030e46c840148df2814e0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;commit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;52ecfdf1eb345e09c6a6edf4a8d3dd5c8079c51c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;boot-success&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;pr&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">42</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-generate-ostree-build-config">3. Generate ostree build config<a href="#3-generate-ostree-build-config" class="hash-link" aria-label="Direct link to 3. Generate ostree build config" title="Direct link to 3. Generate ostree build config">​</a></h4>
<p>This stage of the workflow runs the <code>./test/generate-ostree-build-config</code> script. It has the same purpose as the config generator in the first step, but it sets up ostree containers to serve commits to generate manifests for the image types that depend on them.</p>
<p>The config generator:</p>
<ul>
<li>Generates all the manifests for build config dependencies for a given distribution and architecture using the <code>./cmd/gen-manifests</code> tool.<!-- -->
<ul>
<li>Build config dependencies are image type and config pairings that appear in the <code>depends</code> part of a build config .</li>
<li>For example <a href="https://github.com/osbuild/images/tree/main/test/configs/iot-ostree-pull-empty.json" target="_blank" rel="noopener noreferrer">iot-ostree-pull-empty</a>) will cause a manifest to be generated for <code>iot-container</code> with the <code>empty</code> config for all distros.</li>
</ul>
</li>
<li>Determines the container name and tag from the build name and manifest ID and pulls each container from the registry.</li>
<li>Runs each container with a unique port mapped to the internal web service port.</li>
<li>For each build config that defines a dependency and for each image that config applies to, creates build configs and a config list that defines the URL, port, and ref for the ostree commit source.<!-- -->
<ul>
<li>For example, the config <a href="https://github.com/osbuild/images/tree/main/test/configs/iot-ostree-pull-empty.json" target="_blank" rel="noopener noreferrer">iot-ostree-pull-empty</a>) is mapped in the <a href="https://github.com/osbuild/images/tree/main/test/config-list.json" target="_blank" rel="noopener noreferrer">config-list</a> to the image types <code>iot-ami</code>, <code>iot-installer</code>, <code>iot-raw-image</code>, and <code>iot-vsphere</code>. This will create four configs for each distro, one for each image type, that will all have ostree options to pull an ostree commit from an <code>iot-container</code> of the same distro.</li>
</ul>
</li>
<li>Generates all the manifests defined in the config list that was generated in the previous step.<!-- -->
<ul>
<li>Note that this manifest generation step uses the <code>-skip-noconfig</code> flag, which means that any image type not defined in the list is skipped.</li>
</ul>
</li>
<li>Downloads the test build cache.</li>
<li>Filters out any manifest with an ID that exists in the build cache.</li>
<li>For each remaining manifest, creates a job which builds, boots (if applicable), and uploads the results to the build cache for a given distro, image type, and config file.<!-- -->
<ul>
<li><code>./test/scripts/build-image</code> builds the image using osbuild.</li>
<li><code>./test/scripts/boot-image</code> boots the image in the appropriate cloud or virtual environment (if supported).</li>
<li><code>./test/scripts/upload-results</code> uploads the results (manifest, image file, and build info) to the CI S3 bucket, so that rebuilds of the same manifest ID can be skipped.</li>
</ul>
</li>
<li>If no builds are needed, it generates a <code>NullConfig</code>, which is a simple shell runner that exits successfully. This is required because the child pipeline config cannot be empty.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-dynamic-ostree-build-job">4. Dynamic ostree build job<a href="#4-dynamic-ostree-build-job" class="hash-link" aria-label="Direct link to 4. Dynamic ostree build job" title="Direct link to 4. Dynamic ostree build job">​</a></h4>
<p>Each build job runs in parallel. For each image that is successfully built, a file is added to the test build cache, just like for the previous build job in stage 2.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="definitions">Definitions<a href="#definitions" class="hash-link" aria-label="Direct link to Definitions" title="Direct link to Definitions">​</a></h2>
<ul>
<li><code>&lt;distro&gt;</code>: distribution name and version (e.g. <code>fedora-41</code>).</li>
<li><code>&lt;arch&gt;</code>: architecture (one of <code>x86_64</code>, <code>aarch64</code>, <code>ppc64le</code>, <code>s390x</code>).</li>
<li><code>&lt;image type&gt;</code>: name of the image type (e.g. <code>qcow2</code>).</li>
<li><code>&lt;config name&gt;</code>: name of a build configuration like the ones found in <code>./test/configs/</code> (e.g. <code>all-customizations</code>).</li>
<li><code>&lt;build name&gt;</code>: a concatenation of all the elements that define a unique build configuration. It is created as <code>&lt;distro&gt;-&lt;arch&gt;-&lt;image type&gt;-&lt;config name&gt;</code> with dashes <code>-</code> in each component replaced by underscores <code>_</code> (e.g. <code>fedora_38-x86_64-qcow2-all_customizations</code>).</li>
<li><code>&lt;manifest ID&gt;</code>: the ID of the last stage of the manifest. The manifest ID is unaffected by content sources (RPM or commit URLs for example) but not by content hashes.</li>
<li><code>&lt;osbuild commit ID&gt;</code>: the commit ID specified in the <code>Schutzfile</code> under <code>&lt;distro&gt;.dependencies.osbuild.commit</code>. If not specified, it defaults to <code>RELEASE</code> and means that osbuild version was installed from the distribution repositories and the <code>&lt;osbuild version&gt;</code> is the released version for the given distribution.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/osbuild/images/blob/main/test/README.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer-guide/projects/images/docs/developer/code-manifest-generation/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Manifest generation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer-guide/projects/koji-image-builder/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">koji-image-builder</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#core-filesdirectories" class="table-of-contents__link toc-highlight">Core files/directories</a></li><li><a href="#manually-image-testing" class="table-of-contents__link toc-highlight">Manually image testing</a></li><li><a href="#running-image-build-tests-locally" class="table-of-contents__link toc-highlight">Running image build tests locally</a></li><li><a href="#image-build-tests-in-gitlab-ci" class="table-of-contents__link toc-highlight">Image build tests in GitLab CI</a><ul><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#dynamic-pipelines" class="table-of-contents__link toc-highlight">Dynamic pipelines</a></li><li><a href="#workflow-details" class="table-of-contents__link toc-highlight">Workflow details</a></li></ul></li><li><a href="#definitions" class="table-of-contents__link toc-highlight">Definitions</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/orgs/osbuild/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://matrix.to/#/#image-builder:fedoraproject.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/osbuild/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/osbuild/osbuild.github.io/commits/6b8dc7f3be9cd6dc147229092aee70baa2d17afa" target="_blank" rel="noopener noreferrer" class="footer__link-item">Changelog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Red Hat, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>