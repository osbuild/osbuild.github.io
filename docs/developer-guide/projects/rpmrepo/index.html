<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developer-guide/projects/rpmrepo/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">RPMrepo Snapshots | Image Builder</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://osbuild.org/docs/developer-guide/projects/rpmrepo/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RPMrepo Snapshots | Image Builder"><meta data-rh="true" name="description" content="RPM Repository Snapshot Management"><meta data-rh="true" property="og:description" content="RPM Repository Snapshot Management"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://osbuild.org/docs/developer-guide/projects/rpmrepo/"><link data-rh="true" rel="alternate" href="https://osbuild.org/docs/developer-guide/projects/rpmrepo/" hreflang="en"><link data-rh="true" rel="alternate" href="https://osbuild.org/docs/developer-guide/projects/rpmrepo/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2d858f81.css">
<script src="/assets/js/runtime~main.da9eecdf.js" defer="defer"></script>
<script src="/assets/js/main.bc19f8c4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="osbuild logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.svg" alt="osbuild logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Image Builder</b></a><a class="navbar__item navbar__link" href="/docs/hosted/architecture/">Hosted</a><a class="navbar__item navbar__link" href="/docs/on-premises/overview/">On Premises</a><a class="navbar__item navbar__link" href="/docs/bootc/">Bootc</a><a class="navbar__item navbar__link" href="/docs/user-guide/introduction/">User Guide</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/developer-guide/index/">Developer Guide</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/osbuild/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/developer-guide/index/">Developer Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/developer-guide/general/">General Topics</a><button aria-label="Expand sidebar category &#x27;General Topics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/developer-guide/projects/">Project Overview</a><button aria-label="Collapse sidebar category &#x27;Project Overview&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/composer-cli/">composer-cli</a><button aria-label="Expand sidebar category &#x27;composer-cli&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/image-builder/">image-builder</a><button aria-label="Expand sidebar category &#x27;image-builder&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/image-builder-crc/">Image Builder console.redhat.com Middleware</a><button aria-label="Expand sidebar category &#x27;Image Builder console.redhat.com Middleware&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer-guide/projects/image-builder-frontend/">Image Builder Frontend</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/images/">Images</a><button aria-label="Expand sidebar category &#x27;Images&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/koji-image-builder/">koji-image-builder</a><button aria-label="Expand sidebar category &#x27;koji-image-builder&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/osbuild/">OSBuild</a><button aria-label="Expand sidebar category &#x27;OSBuild&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/developer-guide/projects/osbuild-composer/">OSBuild Composer</a><button aria-label="Expand sidebar category &#x27;OSBuild Composer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer-guide/projects/rpmrepo/">RPMrepo Snapshots</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer-guide/projects/"><span itemprop="name">Project Overview</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RPMrepo Snapshots</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RPMrepo Snapshots</h1></header>
<p>RPM Repository Snapshot Management</p>
<p>The RPMrepo project creates persistent and immutable snapshots of RPM
repositories. It provides tools and infrastructure to create such snapshots, as
well as host and serve them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="project">Project<a href="#project" class="hash-link" aria-label="Direct link to Project" title="Direct link to Project">​</a></h3>
<ul>
<li><strong>Website</strong>: <a href="https://www.osbuild.org" target="_blank" rel="noopener noreferrer">https://www.osbuild.org</a></li>
<li><strong>Bug Tracker</strong>: <a href="https://github.com/osbuild/rpmrepo/issues" target="_blank" rel="noopener noreferrer">https://github.com/osbuild/rpmrepo/issues</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3>
<p>The requirements for this project are:</p>
<ul>
<li><code>python &gt;= 3.8</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="about">About<a href="#about" class="hash-link" aria-label="Direct link to About" title="Direct link to About">​</a></h3>
<p>RPMrepo is comprised of a set of different utilities and infrastructure. The
main goal is to regularly create immutable snapshots of a set of public and
RedHat-private RPM repositories and provide them for a fixed amount of time
on our own infrastructure.</p>
<p>Our infrastructure is maintained via the OSBuild Terraform configuration. See
the
<a href="https://github.com/osbuild/image-builder-terraform" target="_blank" rel="noopener noreferrer">image-builder-terraform</a>
repository, in particular the
<a href="https://github.com/osbuild/image-builder-terraform/blob/main/rpmrepo.tf" target="_blank" rel="noopener noreferrer">rpmrepo.tf</a>
configuration.</p>
<p>For user documentation on RPMrepo, see:
<a href="https://osbuild.org/docs/developer-guide/projects/rpmrepo/" target="_blank" rel="noopener noreferrer">https://osbuild.org/docs/developer-guide/projects/rpmrepo/</a></p>
<p>The backend implementation of RPMrepo involves the following steps:</p>
<ul>
<li>
<p>Target Repository Configuration</p>
<p>When running snapshot operations, we need to know the list of target RPM
repositories to snapshot, what to call the snapshots, and where to store
the data. This information is currently stored as JSON files in this
repository (see the <code>./repo/</code> subdirectory).</p>
<p>For each target repository, we store a JSON dictionary with the following
information:</p>
<ul>
<li>
<p>&quot;base-url&quot;: The RPM repository base-url to create the snapshot of. An
RPM repository base-url requires the root-level metadata
file to be accessible as <code>repodata/repomd.xml</code>. See the
DNF / RPM documentation for more information, if desired.</p>
</li>
<li>
<p>&quot;platform-id&quot;: The DNF Platform ID to use. This allows to group
multiple snapshots together and share the backend
storage. We use this to deduplicate RPMs in our backend.
This ID can be freely chosen, but all snapshots that
share an ID can only be deleted together. We usually
pick the actual DNF Platform ID (see the DNF
<code>module_platform_id</code> for details) here, but this is
not required.</p>
</li>
<li>
<p>&quot;singleton&quot;: We usually create snapshots regularly. In case a target
repository is already immutable by design, this key can
be set to make sure only a single snapshot of this
repository is ever taken. Simply set this key to the
snapshot suffix to use for the singleton snapshot, and
all snapshot operations will use this suffix (and thus
skipping the operation if it already exists).</p>
</li>
<li>
<p>&quot;snapshot-id&quot;: The name of the snapshot to store it as. Usually this
is the same as the name of this file without extension.
This name can be freely chosen. We usually name
snapshots as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;platform-id&gt;-&lt;arch&gt;-&lt;repo&gt;[-&lt;repo-version&gt;].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that the actual snapshots will get a suffix like
<code>-&lt;date&gt;</code> appended automatically. This field must not
include this suffix in the snapshot ID.</p>
</li>
<li>
<p>&quot;storage&quot;: The ID of the storage location to use. We have different
storage locations for different access rights. For now, this
is just a string that specifies the directory in our backend
storage. See the backend information for possible values.</p>
</li>
</ul>
</li>
<li>
<p>Snapshot Creation</p>
<p>To create snapshots, we use the <code>reposync</code> dnf module. See <code>dnf reposync</code>
for more information. This tool just downloads an entire RPM repository
to local storage. We then index this data for our backend storage and
upload it.</p>
<p>The <code>./src/ctl/</code> directory implements the command-line control client
that we use for this. It is a python module that just wraps <code>dnf reposync</code>
to download a repository, provides indexing helpers, and then wraps the
AWS <code>boto3</code> API to upload everything to our storage.</p>
<p>Note that a single snapshot might store up to 100GiB of data intermittently
and can take up to 8h. Therefore, none of the default script execution
engines can be used, since they either have limited disk-space or limited
execution time.</p>
<p>We provide a container (see the <code>osbuild/containers</code> repository) called
<code>rpmrepo-snapshot</code> which reads the configuration in <code>./repo/</code> and uses the
python module in <code>./src/ctl/</code> to create a snapshot. The container supports
batched execution, thus can be used to create many snapshots in parallel.</p>
</li>
<li>
<p>Storage</p>
<p>We currently store all snapshots in a dedicated AWS S3 bucket called
<code>rpmrepo-storage</code>. Since we store a lot of data, we employ a data
deduplication strategy. All actual data files are stored with their sha256
checksum as name in <code>data/&lt;storage&gt;/&lt;platform-id&gt;/sha256-&lt;checksum&gt;</code>. This
means matching files will be deduplicated if they are stored in the same
storage-directory with the same platform-id.</p>
<p>Since we dropped file-names and paths, we cannot serve an RPM repository
from this checksum-based storage. Therefore, we create shim wrapping layers
that refer to this storage. In <code>data/ref/&lt;platform-id&gt;/&lt;snapshot-id&gt;/...</code>
we store the entire RPM repository, but with empty files. We then attach
AWS S3 metadata to all these empty files and fill in the checksum of their
content. This way, all objects underneath the <code>data/ref/...</code> directory is
empty, and thus free of charge.</p>
<p>Our frontend thus only needs to redirect requests from <code>data/ref/</code> to
the correct underlying file, by reading the checksum metadata.</p>
</li>
<li>
<p>Gateway</p>
<p>The frontend to the RPM repository snapshots is a simple HTTP REST API. It
uses AWS API Gateway to create a simple catch-all REST API that forwards
all HTTP requests to an AWS Lambda script. This script is sourced from
<code>./src/gateway/</code> in this repository.</p>
<p>This scripts provides a multitude of legacy interfaces for all kinds of
operations. See its implementation for details. Its main job is to read
requests to a snapshot, find the file in <code>data/ref/...</code>, read the checksum
from the metadata of this empty file, and then return a 301 HTTP redirect
to the right file in <code>data/&lt;storage&gt;/&lt;platform-id&gt;/sha256-&lt;checksum&gt;</code>. It
is then the client&#x27;s job to follow this redirect and directly download the
file.</p>
<p>Note that we simply redirect clients to the public HTTP interface to AWS
S3. The gateway never transmits any data of the repositories. This keeps
our charges low and makes sure large files are always directly transferred
between AWS S3 and the client.</p>
<p>Several paths in the <code>rpmrepo-storage</code> S3 bucket are publicly accessible.
In particular, <code>data/public/</code>, <code>data/ref/</code>, and <code>data/thread/</code>. The
<code>data/rhvpn/</code> path is <em>NOT</em> publicly accessible. Instead, we have an AWS
VPC Endpoint that opens up this path to all clients from within the RH
VPN. Hence, data stored in this directory is only accessible from within
RH.
Note that <code>data/ref/</code> is public, and as such all snapshots can be listed
and enumerated publicly. Only the file content is possibly protected from
public access. This is intentional, but can be changed in the future if
it poses a problem.</p>
<p>Apart from redirects, the gateway also provides utility functions to
enumerate all snapshots, or redirect to old legacy storage locations of
older RPMrepo revisions.</p>
</li>
<li>
<p>Snapshot Routine</p>
<p>As a single snapshot operation requires a lot of storage and time, we use
custom infrastructure to run this. This used to be Beaker, but for better
reliability, we now schedule the snapshot jobs on AWS Batch. The
previously mentioned <code>rpmrepo-snapshot</code> container is scheduled on AWS Batch
and then will create the requested snapshots.</p>
<p>The snapshot routine can be scheduled as a single job, or as an array job.
If scheduled as single job, you must specify the name of the target
configuration in <code>./repo/</code> to run. If scheduled as an array job, you should
size the array as big as the number of files in <code>./repo/</code> (bigger is fine,
those excess jobs will be no-ops; smaller is less fine, as it will miss
snapshots). The array jobs will then each pick one file in <code>./repo/</code> based
on their ARRAY-JOB-ID.</p>
<p>Furthermore, the snapshot routine requires you to specify the branch and
commit of the <code>rpmrepo</code> repository to use. You can use <code>main</code>+<code>HEAD</code>, but
this will be subject to concurrent changes in the upstream repository. You
are strongly advised to use <code>main</code>+<code>&lt;commit-sha&gt;</code> instead.</p>
<p>Lastly, you can specify the suffix to be used for the snapshots. If you
specify <code>auto</code>, it will use the current date and time (except for singleton
snapshots; see above). You should specify this suffix manually to make
sure all snapshots share a suffix. Otherwise, updating users will be a
hassle.</p>
<p>The AWS Batch interface will allow you to track all the snapshot jobs, see
which failed, and allow you to reschedule individual jobs, if desired.</p>
</li>
<li>
<p>Updating snapshot configurations</p>
<p>The <code>./repo/</code> directory contains all the configuration files for the
snapshots. Each file is a JSON file that specifies the configuration for
one snapshot.</p>
<p>Individual snapshot configurations can be generated using the helper script
<code>./gen-repos.py</code>. Multiple snapshot configurations can be generated by
defining them in <code>./repo-definitions.yaml</code> and then running
<code>./gen-all-repos.py</code>, which internally calls <code>./gen-repos.py</code>.</p>
<p>Updating the snapshot configurations usually consists of deleting unused
configurations, and adding new ones. The most convenient way to do this is
to update the <code>./repo-definitions.yaml</code> file, and then run the
<code>snapshot-configs</code> Makefile target. This will automatically delete all
configurations that are no longer present in the definition file, and
generate new ones.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="list-available-snapshots">List Available Snapshots<a href="#list-available-snapshots" class="hash-link" aria-label="Direct link to List Available Snapshots" title="Direct link to List Available Snapshots">​</a></h3>
<p>If you just need a list of the available snapshots you can query the API like
this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://rpmrepo.osbuild.org/v2/enumerate | jq .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which will return a JSON list of the snapshots names.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="repository">Repository:<a href="#repository" class="hash-link" aria-label="Direct link to Repository:" title="Direct link to Repository:">​</a></h3>
<ul>
<li><strong>web</strong>:   <a href="https://github.com/osbuild/rpmrepo" target="_blank" rel="noopener noreferrer">https://github.com/osbuild/rpmrepo</a></li>
<li><strong>https</strong>: <code>https://github.com/osbuild/rpmrepo.git</code></li>
<li><strong>ssh</strong>:   <code>git@github.com:osbuild/rpmrepo.git</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="license">License:<a href="#license" class="hash-link" aria-label="Direct link to License:" title="Direct link to License:">​</a></h3>
<ul>
<li><strong>Apache-2.0</strong></li>
<li>See LICENSE file for details.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/osbuild/rpmrepo/blob/main/README.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer-guide/projects/osbuild-composer/test/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">osbuild-composer testing information</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#project" class="table-of-contents__link toc-highlight">Project</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#about" class="table-of-contents__link toc-highlight">About</a></li><li><a href="#list-available-snapshots" class="table-of-contents__link toc-highlight">List Available Snapshots</a></li><li><a href="#repository" class="table-of-contents__link toc-highlight">Repository:</a></li><li><a href="#license" class="table-of-contents__link toc-highlight">License:</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/orgs/osbuild/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://matrix.to/#/#image-builder:fedoraproject.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/osbuild/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/osbuild/osbuild.github.io/commits/0ec77a9060048e8605ae20daabce6214f3da50c8" target="_blank" rel="noopener noreferrer" class="footer__link-item">Changelog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Red Hat, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>