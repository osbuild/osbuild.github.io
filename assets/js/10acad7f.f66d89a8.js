"use strict";(self.webpackChunksaurus=self.webpackChunksaurus||[]).push([[6121],{8296:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var r=n(5893),s=n(1151);const t={},o="Image Builder Workers",l={id:"service/Architecture/image-builder-workers",title:"Image Builder Workers",description:"Service Description",source:"@site/docs/service/Architecture/03-image-builder-workers.md",sourceDirName:"service/Architecture",slug:"/service/Architecture/image-builder-workers",permalink:"/docs/service/Architecture/image-builder-workers",draft:!1,unlisted:!1,editUrl:"https://github.com/osbuild/saurus/tree/main/docs/service/Architecture/03-image-builder-workers.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"service",previous:{title:"Image Builder Composer",permalink:"/docs/service/Architecture/image-builder-composer"},next:{title:"Image Builder Koji integration",permalink:"/docs/service/image-builder-koji"}},a={},c=[{value:"Service Description",id:"service-description",level:2},{value:"Technology Stack",id:"technology-stack",level:2},{value:"Components",id:"components",level:2},{value:"Routes",id:"routes",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Internal",id:"internal",level:3},{value:"External",id:"external",level:3},{value:"Service Diagram",id:"service-diagram",level:2},{value:"Application Success Criteria",id:"application-success-criteria",level:2},{value:"State",id:"state",level:2},{value:"Load Testing",id:"load-testing",level:2},{value:"Capacity",id:"capacity",level:2}];function d(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.h1,{id:"image-builder-workers",children:"Image Builder Workers"}),"\n",(0,r.jsx)(i.h1,{id:"image-builder-workers-architecture-document",children:"Image Builder Workers Architecture Document"}),"\n",(0,r.jsx)(i.h2,{id:"service-description",children:"Service Description"}),"\n",(0,r.jsxs)(i.p,{children:["The ",(0,r.jsx)(i.code,{children:"workers"})," are a fleet of (for now) amazon EC2 instances, responsible for requesting pending jobs\nfrom the composer-worker API in AOC, perform jobs as instructed and report back the results. The\nkinds of jobs are:"]}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"determining build instructions for future image builds"}),"\n",(0,r.jsx)(i.li,{children:"building images"}),"\n",(0,r.jsx)(i.li,{children:"uploading images to their destination"}),"\n",(0,r.jsx)(i.li,{children:"registering images in their target platform"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:"Workers are stateless, apart from their caches, and hence trivially restartable. To build images\nworkers need to be running in a VM with kernel access, rather than in a container, and in order\nto upload the results the workers need the right credentials for each of the possible targets. In\norder to request new jobs, the workers need to be issued with RH credentials."}),"\n",(0,r.jsx)(i.h2,{id:"technology-stack",children:"Technology Stack"}),"\n",(0,r.jsxs)(i.p,{children:["The service is written in Golang, and the list of vendored dependencies can be found in\n",(0,r.jsx)(i.a,{href:"https://github.com/osbuild/osbuild-composer/blob/main/go.mod",children:"go.mod"}),". The underlying tool is written\nin python3."]}),"\n",(0,r.jsx)(i.p,{children:"Both the service and underlying tool are built as RPMs and installed into AMIs. Their dependencies are\nspecified in their respective .spec files:"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:(0,r.jsx)(i.a,{href:"https://github.com/osbuild/osbuild/blob/main/osbuild.spec",children:"https://github.com/osbuild/osbuild/blob/main/osbuild.spec"})}),"\n",(0,r.jsx)(i.li,{children:(0,r.jsx)(i.a,{href:"https://github.com/osbuild/osbuild-composer/blob/main/osbuild-composer.spec",children:"https://github.com/osbuild/osbuild-composer/blob/main/osbuild-composer.spec"})}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"components",children:"Components"}),"\n",(0,r.jsx)(i.p,{children:"The service consists of a fleet of workers. If no workers are available, no jobs will be built until\nworkers are again available. Nothing is lost as jobs will stay in the queue, but everything will\nsimply stall."}),"\n",(0,r.jsx)(i.h2,{id:"routes",children:"Routes"}),"\n",(0,r.jsx)(i.p,{children:"The workers expose no routes."}),"\n",(0,r.jsx)(i.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,r.jsx)(i.p,{children:"The workers have the following internal and external dependencies."}),"\n",(0,r.jsx)(i.h3,{id:"internal",children:"Internal"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Red Hat SSO for authentication. Without this, the worker cannot request new jobs."}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"external",children:"External"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"EC2. Without this the workers cannot run."}),"\n",(0,r.jsx)(i.li,{children:"EC2, GCP and Azure to upload the respective images. Without this image upload will fail."}),"\n",(0,r.jsx)(i.li,{children:"S3 to upload images for download by the user. Without this image upload will fail."}),"\n",(0,r.jsx)(i.li,{children:"Packer as a build tool. Without this, the service cannot be redeployed."}),"\n",(0,r.jsx)(i.li,{children:"TerraForm as a deployment orchestrator. Without this, the service cannot be redeployed."}),"\n",(0,r.jsx)(i.li,{children:"Github as an upstream repository. Without this, the service cannot be redeployed."}),"\n",(0,r.jsx)(i.li,{children:"Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land."}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"service-diagram",children:"Service Diagram"}),"\n",(0,r.jsx)(i.p,{children:"See parent page."}),"\n",(0,r.jsx)(i.h2,{id:"application-success-criteria",children:"Application Success Criteria"}),"\n",(0,r.jsx)(i.p,{children:"The worker fleet is successful if:"}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsx)(i.li,{children:"It scales on demand to avoid pending jobs having overly long queue times."}),"\n",(0,r.jsx)(i.li,{children:"The jobs are executed in a timely fashion."}),"\n",(0,r.jsx)(i.li,{children:"The job error rate (including image builds and uploads) is low."}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"state",children:"State"}),"\n",(0,r.jsx)(i.p,{children:"Workers only have ephemeral state."}),"\n",(0,r.jsx)(i.p,{children:"To optimize build-times, workers will keep a cache of previously (partially) built or downloaded\nartifacts if this is lost it will be recreated on demand with no other loss than extra running time."}),"\n",(0,r.jsx)(i.h2,{id:"load-testing",children:"Load Testing"}),"\n",(0,r.jsxs)(i.p,{children:["Image Builder is currently being load tested on a weekly basis with failure thresholds reflecting the\nSLIs. The load tests happen against stage CRC. An example can be found\n",(0,r.jsx)(i.a,{href:"https://gitlab.com/osbuild/ci/image-builder/-/jobs/1541382293",children:"here"}),"."]}),"\n",(0,r.jsx)(i.p,{children:"The load testing happens against stage, and tests the entire stack, including the workers."}),"\n",(0,r.jsx)(i.h2,{id:"capacity",children:"Capacity"}),"\n",(0,r.jsx)(i.p,{children:"Increasing the rate at which workers can handle jobs is easily done by scaling up the ASG."}),"\n",(0,r.jsx)(i.p,{children:"The workers are also limited by a 2 week image retention period in our cloud accounts. For GCP\nimages this means there's can have a maximum of 1000 images stored at any given time. For AWS it's\nlimited by the snapshots per region limit (100k). And it's limited by the amount of images that can\nconcurrently be imported (20). The latter might pose a problem in future."})]})}function h(e={}){const{wrapper:i}={...(0,s.a)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1151:(e,i,n)=>{n.d(i,{Z:()=>l,a:()=>o});var r=n(7294);const s={},t=r.createContext(s);function o(e){const i=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(t.Provider,{value:i},e.children)}}}]);