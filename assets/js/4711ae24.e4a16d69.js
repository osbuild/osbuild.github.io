"use strict";(self.webpackChunksaurus=self.webpackChunksaurus||[]).push([[6885],{764:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var n=t(5893),s=t(1151);const r={},a="Image Builder Composer API Architecture Document",o={id:"service/image-builder-composer",title:"Image Builder Composer API Architecture Document",description:"Service Description",source:"@site/docs/service/image-builder-composer.md",sourceDirName:"service",slug:"/service/image-builder-composer",permalink:"/docs/service/image-builder-composer",draft:!1,unlisted:!1,editUrl:"https://github.com/osbuild/saurus/tree/main/docs/service/image-builder-composer.md",tags:[],version:"current",frontMatter:{},sidebar:"service",previous:{title:"architecture",permalink:"/docs/service/architecture"},next:{title:"Image Builder CRC API Architecture Document",permalink:"/docs/service/image-builder-crc"}},c={},d=[{value:"Service Description",id:"service-description",level:2},{value:"Multitenancy",id:"multitenancy",level:2},{value:"Technology Stack",id:"technology-stack",level:2},{value:"Components",id:"components",level:2},{value:"Routes",id:"routes",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Internal",id:"internal",level:3},{value:"External",id:"external",level:3},{value:"Service Diagram",id:"service-diagram",level:2},{value:"Application Success Criteria",id:"application-success-criteria",level:2},{value:"State",id:"state",level:2},{value:"Load Testing",id:"load-testing",level:2},{value:"Capacity",id:"capacity",level:2}];function l(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.h1,{id:"image-builder-composer-api-architecture-document",children:"Image Builder Composer API Architecture Document"}),"\n",(0,n.jsx)(i.h2,{id:"service-description",children:"Service Description"}),"\n",(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.code,{children:"image-builder-composer"})," API routed via ",(0,n.jsx)(i.a,{href:"https://api.openshift.com/",children:"api.openshift.com"})," serves as a\njob queue for pending image builds as well as a metadata-store for already built images. When an image\nbuild is queued via the API it is turned into a set of jobs that are put on the job queue, and together\ndo the necessary tasks to determine how the image should be built, build the image, upload the image to\nits destination, and possibly register or import it to its final format."]}),"\n",(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.code,{children:"image-builder-worker"})," API routed via ",(0,n.jsx)(i.a,{href:"https://api.openshift.com/",children:"api.openshift.com"})," serves as the\nother side of the job queue, where jobs can be dequeued to be executed and their results posted."]}),"\n",(0,n.jsxs)(i.p,{children:["The actual jobs are executed by ",(0,n.jsx)(i.code,{children:"workers"}),", which is outside the scope of this document."]}),"\n",(0,n.jsx)(i.h2,{id:"multitenancy",children:"Multitenancy"}),"\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.code,{children:"osbuild-composer"})," deployments in both ",(0,n.jsx)(i.a,{href:"https://api.openshift.com/",children:"api.openshift.com"})," and ",(0,n.jsx)(i.a,{href:"https://api.stage.openshift.com/",children:"api.stage.openshift.com"})," have support for running builds for multiple tenants. Jobs created by a tenant can be picked only by workers belonging to the same tenant."]}),"\n",(0,n.jsxs)(i.p,{children:["The tenant of an API request is currently determined from the JWT token that the API caller used. Specifically, the implementation extracts the tenant ID from ",(0,n.jsx)(i.code,{children:"rh-org-id"})," or ",(0,n.jsx)(i.code,{children:"account_id"})," fields. This is defined in ",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/osbuild-composer/blob/de72b36dddfc703d76d79479dde7b92f0a78e924/templates/composer.yml#L261",children:"the deployment template"}),"."]}),"\n",(0,n.jsxs)(i.p,{children:["Internally in ",(0,n.jsx)(i.code,{children:"osbuild-composer"}),", the tenant ID is prefixed with ",(0,n.jsx)(i.code,{children:"org-"})," and saved to the jobqueue as a ",(0,n.jsx)(i.code,{children:"channel"}),", see ",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/osbuild-composer/blob/de72b36dddfc703d76d79479dde7b92f0a78e924/pkg/jobqueue/jobqueue.go#L35",children:"composer's source code"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"technology-stack",children:"Technology Stack"}),"\n",(0,n.jsxs)(i.p,{children:["The service is written in Golang, and the list of dependencies can be found in\n",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/osbuild-composer/blob/main/go.mod",children:"go.mod"}),"."]}),"\n",(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.code,{children:"ubi8/go-toolset:latest"})," container is used as a builder, and ",(0,n.jsx)(i.code,{children:"ubi8/ubi-minimal:latest"})," to run the\nbinary. The container images are located here: ",(0,n.jsx)(i.a,{href:"https://quay.io/repository/app-sre/composer",children:"https://quay.io/repository/app-sre/composer"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"components",children:"Components"}),"\n",(0,n.jsx)(i.p,{children:"The service consists of the composer and the composer-worker apps running in an AppSRE managed cluster,\nand their backing database."}),"\n",(0,n.jsx)(i.p,{children:"If either composer or the database are unavailable, the service does not work at all, new images\ncannot be built, and historical builds cannot be introspected. Already built images that may be in\nused by customers are unaffected, only their history and metadata can no longer be queried through\nthe service."}),"\n",(0,n.jsx)(i.p,{children:"If composer-workers is unavailable, new jobs can be queued and old ones can be queried, but workers\nwill not be able to pick up new jobs until the API is back, and they will not be able to report back\nresults correctly for jobs they finish while the API is down."}),"\n",(0,n.jsx)(i.h2,{id:"routes",children:"Routes"}),"\n",(0,n.jsxs)(i.p,{children:["The public routes are ",(0,n.jsx)(i.code,{children:"/api/image-builder-composer/v2/"})," and ",(0,n.jsx)(i.code,{children:"/api/image-builder/worker/v1/"}),", detailed\nlists can be found at ",(0,n.jsx)(i.a,{href:"https://api.openshift.com/api/image-builder-composer/v2/openapi",children:"https://api.openshift.com/api/image-builder-composer/v2/openapi"})," and\n",(0,n.jsx)(i.a,{href:"https://api.openshift.com/api/image-builder-worker/v1/openapi",children:"https://api.openshift.com/api/image-builder-worker/v1/openapi"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,n.jsx)(i.p,{children:"Composer has the following internal and external dependencies."}),"\n",(0,n.jsx)(i.h3,{id:"internal",children:"Internal"}),"\n",(0,n.jsx)(i.p,{children:"Composer relies on Red Hat SSO for authentication."}),"\n",(0,n.jsx)(i.h3,{id:"external",children:"External"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"AWS RDS for data storage. See the section on state."}),"\n",(0,n.jsx)(i.li,{children:"Quay as a container registry. Without this, the service cannot be redeployed."}),"\n",(0,n.jsx)(i.li,{children:"Github as an upstream repository. Without this, the service cannot be redeployed."}),"\n",(0,n.jsx)(i.li,{children:"Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land."}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"service-diagram",children:"Service Diagram"}),"\n",(0,n.jsx)(i.p,{children:"See parent page."}),"\n",(0,n.jsx)(i.h2,{id:"application-success-criteria",children:"Application Success Criteria"}),"\n",(0,n.jsxs)(i.ol,{children:["\n",(0,n.jsx)(i.li,{children:"Image builds can be queued successfully"}),"\n",(0,n.jsx)(i.li,{children:"Jobs can be dequeued successfully and correctly"}),"\n",(0,n.jsx)(i.li,{children:"Jobs are tracked correctly"}),"\n",(0,n.jsx)(i.li,{children:"The state of historical or in-flight builds can be queried and introspected successfully"}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"state",children:"State"}),"\n",(0,n.jsx)(i.p,{children:"The service depends on a PostgreSQL database, the default postgres12-rds-1 template is used. The\ndatabase stores metadata about each build, making it possible to enumerate past builds as well as\nfunction as a job queue."}),"\n",(0,n.jsx)(i.p,{children:"If the state is lost historical data would be lost, and pending image builds might never get scheduled,\nbut the user could still use their existing images if they have saved the necessary information. Data\nloss would not affect the ability to schedule new builds."}),"\n",(0,n.jsx)(i.h2,{id:"load-testing",children:"Load Testing"}),"\n",(0,n.jsxs)(i.p,{children:["The Image Builder API in console.redhat.com is currently being load tested on a weekly basis with failure\nthresholds reflecting the SLIs. The load tests happen against stage CRC, which is backed by composer in\napi.stage.openshift.com. An example can be found ",(0,n.jsx)(i.a,{href:"https://gitlab.com/osbuild/ci/image-builder/-/jobs/1723976612",children:"here"}),"."]}),"\n",(0,n.jsxs)(i.p,{children:["More information can be found ",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/image-builder/blob/main/test/README.md",children:"upstream"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"capacity",children:"Capacity"}),"\n",(0,n.jsx)(i.p,{children:"The defaults described in App Interface, 1 cpu 512Mi memory per container running in the default three pods are sufficient, and our expectations\nare that this will remain sufficient for the next twelve months."})]})}function h(e={}){const{wrapper:i}={...(0,s.a)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},1151:(e,i,t)=>{t.d(i,{Z:()=>o,a:()=>a});var n=t(7294);const s={},r=n.createContext(s);function a(e){const i=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),n.createElement(r.Provider,{value:i},e.children)}}}]);