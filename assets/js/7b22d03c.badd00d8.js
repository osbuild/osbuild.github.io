"use strict";(self.webpackChunksaurus=self.webpackChunksaurus||[]).push([[5823],{4840:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>l});var n=t(5893),s=t(1151);const r={},a="Image Builder Backend",c={id:"service/Architecture/image-builder-crc",title:"Image Builder Backend",description:"Service Description",source:"@site/docs/service/Architecture/01-image-builder-crc.md",sourceDirName:"service/Architecture",slug:"/service/Architecture/image-builder-crc",permalink:"/docs/service/Architecture/image-builder-crc",draft:!1,unlisted:!1,editUrl:"https://github.com/osbuild/saurus/tree/main/docs/service/Architecture/01-image-builder-crc.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"service",previous:{title:"Architecture",permalink:"/docs/service/Architecture/"},next:{title:"Image Builder Composer",permalink:"/docs/service/Architecture/image-builder-composer"}},o={},l=[{value:"Service Description",id:"service-description",level:2},{value:"Technology Stack",id:"technology-stack",level:2},{value:"Components",id:"components",level:2},{value:"Routes",id:"routes",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Internal",id:"internal",level:3},{value:"External",id:"external",level:3},{value:"Service Diagram",id:"service-diagram",level:2},{value:"Application Success Criteria",id:"application-success-criteria",level:2},{value:"SLOs",id:"slos",level:2},{value:"Latency",id:"latency",level:3},{value:"Stability",id:"stability",level:3},{value:"State",id:"state",level:2},{value:"Load Testing",id:"load-testing",level:2},{value:"Capacity",id:"capacity",level:2}];function d(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.h1,{id:"image-builder-backend",children:"Image Builder Backend"}),"\n",(0,n.jsx)(i.h1,{id:"image-builder-crc-api-architecture-document",children:"Image Builder CRC API Architecture Document"}),"\n",(0,n.jsx)(i.h2,{id:"service-description",children:"Service Description"}),"\n",(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.code,{children:"image-builder"})," API in CRC serves as the public API used either directly by customers or through the\nCRC UI. Through this API customers can create, manage and view image builds. The service in CRC is\nresponsible for access management, quotas, rate-limiting, etc. In the future it may interact with other\nservices in CRC in order to add value to the image build experience."]}),"\n",(0,n.jsxs)(i.p,{children:["The actual image build requests are passed on to ",(0,n.jsx)(i.code,{children:"composer"}),", which is outside the scope of this document."]}),"\n",(0,n.jsx)(i.h2,{id:"technology-stack",children:"Technology Stack"}),"\n",(0,n.jsxs)(i.p,{children:["The service is written in Golang, and the list of dependencies can be found in\n",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/image-builder/blob/main/go.mod",children:"go.mod"}),"."]}),"\n",(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.code,{children:"ubi8/go-toolset:latest"})," container is used as a builder, and ",(0,n.jsx)(i.code,{children:"ubi8/ubi-minimal:latest"})," to run the\nbinary. The container images are located here: ",(0,n.jsx)(i.a,{href:"https://quay.io/repository/cloudservices/image-builder",children:"https://quay.io/repository/cloudservices/image-builder"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"components",children:"Components"}),"\n",(0,n.jsx)(i.p,{children:"The service consists of the image-builder app running in CRC, and its backing database. If either of\nthese are unavailable, the service does not work at all, new images cannot be built, and historical\nbuilds cannot be introspected. Already built images that may be in used by customers are unaffected,\nonly their history and metadata can no longer be queried through the service."}),"\n",(0,n.jsx)(i.h2,{id:"routes",children:"Routes"}),"\n",(0,n.jsxs)(i.p,{children:["The public route is ",(0,n.jsx)(i.code,{children:"/api/v1/image-builder"}),", a detailed list can be found at\n",(0,n.jsx)(i.a,{href:"https://console.redhat.com/docs/api/image-builder",children:"https://console.redhat.com/docs/api/image-builder"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,n.jsx)(i.p,{children:"Image builder has the following internal and external dependencies."}),"\n",(0,n.jsx)(i.h3,{id:"internal",children:"Internal"}),"\n",(0,n.jsxs)(i.p,{children:["Image Builder relies on 3Scale to set the ",(0,n.jsx)(i.code,{children:"x-rh-identity"})," header. It uses the header for authentication,\nand quota application. It also uses the account number to map previously made compose requests to that\naccount number."]}),"\n",(0,n.jsx)(i.h3,{id:"external",children:"External"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"AWS RDS for data storage. See the section on state."}),"\n",(0,n.jsx)(i.li,{children:"Quay as a container registry. Without this, the service cannot be redeployed."}),"\n",(0,n.jsx)(i.li,{children:"Github as an upstream repository. Without this, the service cannot be redeployed."}),"\n",(0,n.jsx)(i.li,{children:"Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land."}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"service-diagram",children:"Service Diagram"}),"\n",(0,n.jsx)(i.p,{children:"See parent page."}),"\n",(0,n.jsx)(i.h2,{id:"application-success-criteria",children:"Application Success Criteria"}),"\n",(0,n.jsxs)(i.ol,{children:["\n",(0,n.jsx)(i.li,{children:"Customers can queue image builds and view their state."}),"\n",(0,n.jsx)(i.li,{children:"Customers can introspect and manage existing builds."}),"\n",(0,n.jsx)(i.li,{children:"Quotas are applied according to policy to manage cost of running the service."}),"\n",(0,n.jsx)(i.li,{children:"The service is able to provide functionality to make its own functionality discoverable"}),"\n"]}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"Enumerate supported features"}),"\n",(0,n.jsx)(i.li,{children:"Package search"}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"slos",children:"SLOs"}),"\n",(0,n.jsx)(i.p,{children:"The image builder API has the following SLOs, but we aim to add more and make these stricter as we\ngain more experience from production. Our SLO targets are defined in App Interface."}),"\n",(0,n.jsx)(i.h3,{id:"latency",children:"Latency"}),"\n",(0,n.jsxs)(i.p,{children:["The ratio of requests that are considered significantly fast. The aim is to make it possible\nto have a responsive UI. The exception is currently the ",(0,n.jsx)(i.code,{children:"/compose"})," call, which is long-running and\nour SLO targets reflect a higher latency threshold. The UI must be implemented with this\nin mind."]}),"\n",(0,n.jsx)(i.h3,{id:"stability",children:"Stability"}),"\n",(0,n.jsxs)(i.p,{children:["The proportion of successful (or unsuccessful due to user error) ",(0,n.jsx)(i.code,{children:"/compose"})," requests. The aim is for users\nto be able to reliably queue image builds, even if some retries are required."]}),"\n",(0,n.jsx)(i.h2,{id:"state",children:"State"}),"\n",(0,n.jsx)(i.p,{children:"The service depends on a PostgreSQL database, the default postgres12-rds-1 template is used. The\ndatabase stores metadata about each build, making it possible to enumerate past builds and to enforce\nquota limits. If the state is lost historical data would be lost, but the user could still use their\nimages if they have saved the necessary information. The quote calculations would be off, but in the\nworst case scenario customers would be able to build more images than they are meant to, which would\nnot be a big problem."}),"\n",(0,n.jsx)(i.h2,{id:"load-testing",children:"Load Testing"}),"\n",(0,n.jsxs)(i.p,{children:["Image Builder is currently being load tested on a weekly basis with failure thresholds reflecting the\nSLIs. The load tests happen against stage CRC. An example can be found\n",(0,n.jsx)(i.a,{href:"https://gitlab.com/osbuild/ci/image-builder/-/jobs/1541382293",children:"here"}),"."]}),"\n",(0,n.jsxs)(i.p,{children:["More information can be found ",(0,n.jsx)(i.a,{href:"https://github.com/osbuild/image-builder/blob/main/test/README.md",children:"upstream"}),"."]}),"\n",(0,n.jsx)(i.h2,{id:"capacity",children:"Capacity"}),"\n",(0,n.jsx)(i.p,{children:"The needed capacity might grow a little bit in all directions (DB and number of pods), but any growth should\nbe slow. Currently  pods are running, and limits have been set on memory or cpu usage. The default insights\nlimits and quotas are used, which should be more than enough."})]})}function h(e={}){const{wrapper:i}={...(0,s.a)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,i,t)=>{t.d(i,{Z:()=>c,a:()=>a});var n=t(7294);const s={},r=n.createContext(s);function a(e){const i=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),n.createElement(r.Provider,{value:i},e.children)}}}]);