"use strict";(self.webpackChunksaurus=self.webpackChunksaurus||[]).push([[5433],{78055:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>a,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"developer-guide/projects/koji-image-builder/installation","title":"Installation","description":"\x3c!--","source":"@site/docs/developer-guide/02-projects/koji-image-builder/00-installation.md","sourceDirName":"developer-guide/02-projects/koji-image-builder","slug":"/developer-guide/projects/koji-image-builder/installation","permalink":"/docs/developer-guide/projects/koji-image-builder/installation","draft":false,"unlisted":false,"editUrl":"https://github.com/osbuild/koji-image-builder/blob/main/doc/00-installation.md","tags":[],"version":"current","sidebarPosition":0,"frontMatter":{"custom_edit_url":"https://github.com/osbuild/koji-image-builder/blob/main/doc/00-installation.md"},"sidebar":"developer","previous":{"title":"koji-image-builder","permalink":"/docs/developer-guide/projects/koji-image-builder/"},"next":{"title":"OSBuild","permalink":"/docs/developer-guide/projects/osbuild/"}}');var d=t(74848),r=t(28453);const a={custom_edit_url:"https://github.com/osbuild/koji-image-builder/blob/main/doc/00-installation.md"},o="Installation",s={},l=[{value:"Infrastructure",id:"infrastructure",level:2},{value:"Hub",id:"hub",level:3},{value:"Configuration",id:"configuration",level:4},{value:"Builder",id:"builder",level:3},{value:"Configuration",id:"configuration-1",level:4},{value:"Web",id:"web",level:3},{value:"Koji Setup",id:"koji-setup",level:2}];function u(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(i.header,{children:(0,d.jsx)(i.h1,{id:"installation",children:"Installation"})}),"\n",(0,d.jsxs)(i.p,{children:[(0,d.jsx)(i.code,{children:"koji-image-builder"})," is comprised of several (sub) packages that need to be deployed on the various parts\nthat make up your ",(0,d.jsx)(i.a,{href:"https://docs.pagure.org/koji/",children:"Koji"})," installation. Installing ",(0,d.jsx)(i.code,{children:"koji-image-builder"})," provides the ",(0,d.jsx)(i.code,{children:"imageBuilderBuild"})," and ",(0,d.jsx)(i.code,{children:"imageBuilderBuildArch"})," task types."]}),"\n",(0,d.jsxs)(i.p,{children:[(0,d.jsx)(i.code,{children:"koji-image-builder"})," and its subpackages are available in Fedora, EPEL 8, EPEL 9, and EPEL 10 and can be installed through ",(0,d.jsx)(i.code,{children:"dnf"}),". ",(0,d.jsx)(i.code,{children:"image-builder"})," itself needs to be available in the Koji tags (buildroots) you want to use to build images. ",(0,d.jsx)(i.code,{children:"image-builder"})," is packaged for Fedora, CentOS, and RHEL starting with 9.7 and 10.1."]}),"\n",(0,d.jsx)(i.p,{children:"The installation section is comprised of two parts, one is to install the appropriate packages in the right places and to configure them to be enabled. The second part is the general Koji configuration regarding tags and groups and such."}),"\n",(0,d.jsx)(i.h2,{id:"infrastructure",children:"Infrastructure"}),"\n",(0,d.jsxs)(i.p,{children:["While every Koji deployment is slightly different it might be useful to take a look at the pull requests that enabled ",(0,d.jsx)(i.code,{children:"koji-image-builder"})," on ",(0,d.jsx)(i.a,{href:"https://pagure.io/fedora-infra/ansible/pull-request/2579#request_diff",children:"Fedora"}),"."]}),"\n",(0,d.jsx)(i.h3,{id:"hub",children:"Hub"}),"\n",(0,d.jsxs)(i.p,{children:["On the machines that act as the 'hub' in ",(0,d.jsx)(i.code,{children:"koji"})," you want to install the ",(0,d.jsx)(i.code,{children:"koji-image-builder-hub"})," package."]}),"\n",(0,d.jsx)(i.h4,{id:"configuration",children:"Configuration"}),"\n",(0,d.jsxs)(i.p,{children:["In your ",(0,d.jsx)(i.code,{children:"hub.conf"})," make sure that ",(0,d.jsx)(i.code,{children:"image_builder"})," is included in the list of ",(0,d.jsx)(i.code,{children:"Plugins"}),":"]}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"Plugins = ... image_builder\n"})}),"\n",(0,d.jsx)(i.h3,{id:"builder",children:"Builder"}),"\n",(0,d.jsxs)(i.p,{children:["On all builders that you want to be able to serve tasks of the ",(0,d.jsx)(i.code,{children:"imageBuilderBuild"}),", or ",(0,d.jsx)(i.code,{children:"imageBuilderBuildArch"})," types you should install the ",(0,d.jsx)(i.code,{children:"koji-image-builder-builder"})," package. If you're using specific Koji channels for image builds that means all machines in those channels."]}),"\n",(0,d.jsx)(i.h4,{id:"configuration-1",children:"Configuration"}),"\n",(0,d.jsxs)(i.p,{children:["In your ",(0,d.jsx)(i.code,{children:"kojid.conf"})," make sure that ",(0,d.jsx)(i.code,{children:"image_builder"})," is included in the list of ",(0,d.jsx)(i.code,{children:"Plugins"}),":"]}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"Plugins = ... image_builder\n"})}),"\n",(0,d.jsxs)(i.p,{children:["Restart ",(0,d.jsx)(i.code,{children:"kojid"})," afterwards."]}),"\n",(0,d.jsx)(i.h3,{id:"web",children:"Web"}),"\n",(0,d.jsxs)(i.p,{children:["On the machines that host your Koji's web interface you want to make sure the tasks are listed in the configuration. Make sure that the ",(0,d.jsx)(i.code,{children:"Tasks"})," list contains ",(0,d.jsx)(i.code,{children:"imageBuilderBuild"})," and ",(0,d.jsx)(i.code,{children:"imageBuilderBuildArch"}),":"]}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"Tasks = ...,imageBuilderBuild,imageBuilderBuildArch\n"})}),"\n",(0,d.jsxs)(i.p,{children:["And make sure that the ",(0,d.jsx)(i.code,{children:"ParentTasks"})," list contains ",(0,d.jsx)(i.code,{children:"imageBuilderBuild"}),":"]}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"ParentTasks = ...,imageBuilderBuild\n"})}),"\n",(0,d.jsx)(i.h2,{id:"koji-setup",children:"Koji Setup"}),"\n",(0,d.jsx)(i.p,{children:"After you've finished the infrastructure part of your deployment it's time to configure Koji so tasks can be submitted and processed. The commands here are to be executed as a user with administrative privileges on your relevant Koji instance. Take the examples and adjust them to what's appropriate for your setup."}),"\n",(0,d.jsx)(i.p,{children:"To start with you need a tag you're going to use to build images in, this can be a pre-existing tag, or a new one. You might want to set up tag inheritance to appropriate other tags but this is setup dependent."}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"# Create a new tag\n$ koji add-tag image-builder-build\n\n# Set the tag to use 'old chroots', `image-builder` needs loopback devices and these do\n# not work with 'new chroot'.\n$ koji edit-tag -x mock.new_chroot=0 image-builder-build\n"})}),"\n",(0,d.jsx)(i.p,{children:"You likely already have tags you want to build images for. You can add a target for those:"}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"# Add the target `target-name` which takes the `image-builder-build` build tag\n# and tags builds into `destination-tag`\n$ koji add-target target-name image-builder-build destination-tag\n"})}),"\n",(0,d.jsx)(i.p,{children:"Your build tag needs some packages in it, so let's configure a group for it:"}),"\n",(0,d.jsx)(i.pre,{children:(0,d.jsx)(i.code,{children:"# Add the `image-builder` group to the `image-builder-build` tag\n$ koji add-group image-builder-build image-builder\n\n# Add the `image-builder` package to the `image-builder` group in the `image-builder-build` tag\n$ koji add-group-pkg image-builder-build image-builder image-builder\n"})}),"\n",(0,d.jsxs)(i.p,{children:["After this you should be able to build images with ",(0,d.jsx)(i.code,{children:"image-builder"})," in the ",(0,d.jsx)(i.code,{children:"image-builder-build"})," tag."]})]})}function c(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,d.jsx)(i,{...e,children:(0,d.jsx)(u,{...e})}):u(e)}},28453:(e,i,t)=>{t.d(i,{R:()=>a,x:()=>o});var n=t(96540);const d={},r=n.createContext(d);function a(e){const i=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:a(e.components),n.createElement(r.Provider,{value:i},e.children)}}}]);